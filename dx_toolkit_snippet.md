# DNA Nexus UKB Code Snippets


### - The swiss army knife tool is the best way to run most things through the dx command line
### - it contains a bunch of pre-loaded tools like plink and regenie for genetic analysis
### https://dnanexus.gitbook.io/uk-biobank-rap/working-on-the-research-analysis-platform/running-analysis-jobs/tools-library


# Running one command
### Pasting both blocks of code like this into your terminal will run it immedietaly

## First write the code to a text object (in this case a plink script)
plink_refilter="plink2 \
    --bfile Plinkvars_FADS_UKB_FILTERED_DEC \
    --max-maf 0.01 \
    --mind 0.1 \
    --geno 0.1 \
    --threads 4 \
    --out TEST_LOG"

## Then run the command using SAK
dx run swiss-army-knife \
  -icmd="${plink_refilter}" \
  -iin="/Outputs/Processed_concats/Plinkvars_FADS_UKB_FILTERED_DEC.bed" \
  -iin="/Outputs/Processed_concats/Plinkvars_FADS_UKB_FILTERED_DEC.bim" \
  -iin="/Outputs/Processed_concats/Plinkvars_FADS_UKB_FILTERED_DEC.fam" \
  --tag="PLINK_refilter" \
  --instance-type "mem1_ssd1_v2_x8" \
  --destination="/testoutput/" \
  --brief --yes

### -icmd is your command/actual code in this case it is calling thw whole plink script above
### -iin are your inputs - anything inputted into the command needs to specified by its filepath in your RAP data structire
### --instance-type is how much memory you are requesting for this job
### --destination writes anything generated by your code to a specified location in your UKB RAP file structure


# Running multiple cpommand in one submission
### Multiple commands can be chained in a single submission, in this case filtering and pgen creation are done seperately. 
### - All intermediate files and main output files will be written to the directory 
### - Intermediate files (plink_STEP1 in the below example) do not need to be specified as inputs
### as before copying and pasting both sections into your terminal together will run the job
plink_refilter="plink2 \
    --bfile Plinkvars_FADS_UKB_FILTERED_DEC \
    --max-maf 0.01 \
    --mind 0.1 \
    --make-bed \
    --threads 4 \
    --out plink_STEP1
    
    plink2 \
    --bfile plink_STEP1 \
    --make-pgen \
    --threads 4 \
    --out plink_STEP2
    "
dx run swiss-army-knife \
  -icmd="${plink_refilter}" \
  -iin="/Outputs/Processed_concats/Plinkvars_FADS_UKB_FILTERED_DEC.bed" \
  -iin="/Outputs/Processed_concats/Plinkvars_FADS_UKB_FILTERED_DEC.bim" \
  -iin="/Outputs/Processed_concats/Plinkvars_FADS_UKB_FILTERED_DEC.fam" \
  --tag="PLINK_refilter" \
  --instance-type "mem1_ssd1_v2_x8" \
  --destination="/Outputs/Processed_concats/" \
  --brief --yes



# Using bash scripts in the SAK
#### this is a script to edit columns in a file
### 1. on eddie or locally write your script to a .sh file using vim or nano
### e.g. save this as (test.script.sh) note it has an input and an putput that need specifyting
input="$1"
output="$2"
awk '{ $1 = $2; print }'  "$input" > "$output" 

###2. then upload it to your desired location on your rap 
dx upload test.script.sh --path="/Code/testscripts/"


###3. Execute the command with SAK 
#note the script is specified as an input AND is also called using bash in the icmnd line along with both the input and outputs
dx run swiss-army-knife \
  -icmd="bash fam_fixer.sh Plinkvars_FADS_UKB_FILTERED_0.01_DEC_OG.fam  Plinkvars_FADS_UKB_FILTERED_0.01_DEC.fam" \
  -iin="/Outputs/Processed_concats/Plinkvars_FADS_UKB_FILTERED_0.01_DEC_OG.fam" \
  -iin="/Code/testscripts/test.script.sh" \
 --tag="PLINK_refilter" \
 --instance-type "mem3_ssd2_v2_x8" \
 --destination="/Outputs/Processed_concats/" \
 --brief --yes
  -iin="/Code/testscripts/test.script.sh" \
dx upload test.script.sh --path="/Code/testscripts/"

###NB - alternatively you can make it executable 
chmod +x script.sh
### then th -icmd line becomes: 
-icmd="fam_fixer.sh Plinkvars_FADS_UKB_FILTERED_0.01_DEC_OG.fam  Plinkvars_FADS_UKB_FILTERED_0.01_DEC.fam" \


# running software from docker
### like with the plink command above you specify your text as an object (both blocks can be copypasted into your terminal together)
### the docker image once saved to docker hub can be accessed by adding -iimage to your SAK command.
### This one has the remeta software and related dependecies in it.

remata_ld_make="remeta compute-ref-ld \
        --target-pfile Plinkvars_FADS_UKB_FILTERED_0.01_SEPT \
        --gene-list remeta_gene_list.txt.gz \
        --out UKB_EURONLY_LDref_ALL_SEPT \
        --chr 11 \
        --threads 4 \
        --skip-buffer"

# note the docker image save and copied in
dx run swiss-army-knife \
  -iimage="lnisbet23/remeta:v0.9.0" \
  -icmd="${remata_ld_make}" \
  -iin="/Outputs/remata_prep/Plinkvars_FADS_UKB_FILTERED_0.01_SEPT.pgen" \
  -iin="/Outputs/remata_prep/Plinkvars_FADS_UKB_FILTERED_0.01_SEPT.pvar" \
  -iin="/Outputs/remata_prep/Plinkvars_FADS_UKB_FILTERED_0.01_SEPT.psam" \
  -iin="/Outputs/remata_prep/remeta_gene_list.txt.gz" \
  -iin="/Outputs/remata_prep/UKB_MM10_varlist.txt" \
  --tag="remeta_LD" \
  --instance-type "mem1_ssd1_v2_x16" \
  --destination="/Outputs/remata_prep/" \
  --brief --yes
